const { app, BrowserWindow, Tray, Menu, nativeImage, ipcMain } = require('electron');
const path = require('path');
const schedule = require('node-schedule');
const axios = require('axios');
const fs = require('fs');
const config = require('./config');

let mainWindow;
let tray;
let stockData = new Map();
let refreshInterval = config.stockDataRefreshInterval;
let stockCodes = config.defaultStockCodes;
let isRunning = false;
let currentStockIndex = 0; // å½“å‰æ˜¾ç¤ºçš„è‚¡ç¥¨ç´¢å¼•
let stockDisplayTimer = null; // è‚¡ç¥¨æ˜¾ç¤ºè½®æ’­å®šæ—¶å™¨

// åº”ç”¨é…ç½®
app.commandLine.appendSwitch('--disable-gpu-cache');
app.commandLine.appendSwitch('--disable-software-rasterizer');
app.commandLine.appendSwitch('--disable-background-timer-throttling');
app.commandLine.appendSwitch('--disable-renderer-backgrounding');
app.commandLine.appendSwitch('--disable-backgrounding-occluded-windows');

// åˆ›å»ºä¸»çª—å£
function createWindow() {
    console.log('æ­£åœ¨åˆ›å»ºä¸»çª—å£...');

    mainWindow = new BrowserWindow({
        width: 400,
        height: 600,
        webPreferences: {
            nodeIntegration: false,
            contextIsolation: true,
            preload: path.join(__dirname, 'preload.js'),
            enableRemoteModule: false,
            webSecurity: true,
            allowRunningInsecureContent: false
        },
        icon: path.join(__dirname, 'assets/icon.png'),
        show: true, // æ”¹ä¸ºtrueï¼Œè®©çª—å£æ˜¾ç¤º
        resizable: false,
        minimizable: false,
        maximizable: false,
        skipTaskbar: false, // åœ¨ä»»åŠ¡æ æ˜¾ç¤º
        alwaysOnTop: false
    });

    console.log('ä¸»çª—å£å·²åˆ›å»ºï¼Œæ­£åœ¨åŠ è½½HTMLæ–‡ä»¶...');
    mainWindow.loadFile('index.html');

    // çª—å£å…³é—­æ—¶éšè—è€Œä¸æ˜¯é€€å‡º
    mainWindow.on('close', (event) => {
        if (!app.isQuiting) {
            event.preventDefault();
            mainWindow.hide();
        }
    });

    // å¼€å‘æ¨¡å¼ä¸‹æ˜¾ç¤ºå¼€å‘è€…å·¥å…·
    if (process.argv.includes('--dev')) {
        mainWindow.webContents.openDevTools();
        console.log('å¼€å‘æ¨¡å¼å·²å¯ç”¨ï¼Œå¼€å‘è€…å·¥å…·å·²æ‰“å¼€');
    }

    console.log('ä¸»çª—å£åˆ›å»ºå®Œæˆ');
}

// åˆ›å»ºä»»åŠ¡æ æŒ‰é’®ï¼ˆç±»ä¼¼èµ„è®¯ä¸Žå…´è¶£ï¼‰
function createTaskbarButton() {
    console.log('æ­£åœ¨åˆ›å»ºä»»åŠ¡æ æŒ‰é’®...');

    try {
        // æ£€æŸ¥å›¾æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        const iconPath = path.join(__dirname, 'assets/icon.png');
        if (!fs.existsSync(iconPath)) {
            console.warn('å›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡');
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„é»˜è®¤å›¾æ ‡
            const defaultIcon = nativeImage.createFromBuffer(Buffer.from([
                0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D,
                0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10,
                0x08, 0x06, 0x00, 0x00, 0x00, 0x1F, 0xF3, 0xFF, 0x61, 0x00, 0x00, 0x00,
                0x0C, 0x49, 0x44, 0x41, 0x54, 0x78, 0x9C, 0x63, 0x60, 0x18, 0x05, 0x00,
                0x00, 0x00, 0x06, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
            ]));
            mainWindow.setIcon(defaultIcon);
        } else {
            const icon = nativeImage.createFromPath(iconPath);
            icon.resize({ width: 16, height: 16 });
            mainWindow.setIcon(icon);
        }

        // è®¾ç½®åˆå§‹ä»»åŠ¡æ æ ‡é¢˜
        mainWindow.setTitle('è‚¡ç¥¨è¡Œæƒ…å°å·¥å…·');

        // ç‚¹å‡»ä»»åŠ¡æ æŒ‰é’®æ˜¾ç¤º/éšè—çª—å£
        mainWindow.on('show', () => {
            console.log('çª—å£å·²æ˜¾ç¤º');
        });

        mainWindow.on('hide', () => {
            console.log('çª—å£å·²éšè—');
        });

        // æ·»åŠ å³é”®èœå•æ”¯æŒ
        if (config.taskbarButton.rightClickMenu) {
            mainWindow.webContents.on('context-menu', (event, params) => {
                event.preventDefault();
                showContextMenu(params.x, params.y);
            });
        }

        console.log('ä»»åŠ¡æ æŒ‰é’®å·²åˆ›å»º');

    } catch (error) {
        console.error('åˆ›å»ºä»»åŠ¡æ æŒ‰é’®å¤±è´¥:', error);
    }
}

// æ›´æ–°ä»»åŠ¡æ æ ‡é¢˜å’Œæç¤º
function updateTaskbarTitle() {
    if (stockData.size === 0 || !config.showInTaskbar) return;

    try {
        const stockArray = Array.from(stockData.values());
        const currentStock = stockArray[currentStockIndex];

        if (currentStock) {
            // æž„å»ºä»»åŠ¡æ æ ‡é¢˜ï¼ˆç®€çŸ­æ˜¾ç¤ºï¼‰
            let title = '';

            if (config.taskbarDisplayFormat.showEmoji) {
                const changeColor = parseFloat(currentStock.change) >= 0 ? 'ðŸŸ¢' : 'ðŸ”´';
                title += `${changeColor}`;
            }

            title += `${currentStock.code} Â¥${currentStock.currentPrice}`;

            if (config.taskbarDisplayFormat.showChangeSymbol) {
                const changeSymbol = parseFloat(currentStock.change) >= 0 ? 'â†—' : 'â†˜';
                title += ` ${changeSymbol}${currentStock.change}`;
            }

            // è®¾ç½®ä»»åŠ¡æ æ ‡é¢˜
            if (config.taskbarDisplayFormat.showInTitle) {
                mainWindow.setTitle(title);
            }

            // è®¾ç½®ä»»åŠ¡æ æç¤ºï¼ˆæ‚¬åœæ˜¾ç¤ºï¼‰
            if (config.taskbarDisplayFormat.showInTooltip) {
                let tooltipText = '';

                if (config.taskbarDisplayFormat.showEmoji) {
                    const changeColor = parseFloat(currentStock.change) >= 0 ? 'ðŸŸ¢' : 'ðŸ”´';
                    tooltipText += `${changeColor} `;
                }

                tooltipText += `${currentStock.code} ${currentStock.name}\nÂ¥${currentStock.currentPrice}`;

                if (config.taskbarDisplayFormat.showChangeSymbol) {
                    const changeSymbol = parseFloat(currentStock.change) >= 0 ? 'â†—' : 'â†˜';
                    tooltipText += ` ${changeSymbol}${currentStock.change}`;
                }

                if (config.taskbarDisplayFormat.showPercentage) {
                    tooltipText += ` (${currentStock.changePercent}%)`;
                }

                // é™åˆ¶æç¤ºé•¿åº¦
                if (tooltipText.length > config.taskbarDisplayFormat.maxTooltipLength) {
                    tooltipText = tooltipText.substring(0, config.taskbarDisplayFormat.maxTooltipLength) + '...';
                }

                // è®¾ç½®çª—å£æç¤ºï¼ˆä¼šæ˜¾ç¤ºåœ¨ä»»åŠ¡æ æ‚¬åœæ—¶ï¼‰
                mainWindow.setTitle(title);
            }

            console.log(`ä»»åŠ¡æ æ˜¾ç¤º: ${currentStock.code} ${currentStock.name} Â¥${currentStock.currentPrice}`);
        }

        // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè‚¡ç¥¨
        currentStockIndex = (currentStockIndex + 1) % stockArray.length;

    } catch (error) {
        console.error('æ›´æ–°ä»»åŠ¡æ æ˜¾ç¤ºå¤±è´¥:', error);
    }
}

// å¯åŠ¨è‚¡ç¥¨è½®æ’­æ˜¾ç¤º
function startStockRotation() {
    if (!config.enableStockRotation) return;

    if (stockDisplayTimer) {
        clearInterval(stockDisplayTimer);
    }

    // ä½¿ç”¨é…ç½®çš„è½®æ’­é—´éš”
    stockDisplayTimer = setInterval(() => {
        updateTaskbarTitle();
    }, config.stockRotationInterval);

    console.log(`è‚¡ç¥¨è½®æ’­æ˜¾ç¤ºå·²å¯åŠ¨ï¼Œæ¯${config.stockRotationInterval / 1000}ç§’åˆ‡æ¢ä¸€æ¬¡`);
}

// åœæ­¢è‚¡ç¥¨è½®æ’­æ˜¾ç¤º
function stopStockRotation() {
    if (stockDisplayTimer) {
        clearInterval(stockDisplayTimer);
        stockDisplayTimer = null;
    }
}

// èŽ·å–è‚¡ç¥¨æ•°æ®
async function fetchStockData() {
    try {
        console.log('æ­£åœ¨èŽ·å–è‚¡ç¥¨æ•°æ®...');

        // æ¨¡æ‹Ÿè‚¡ç¥¨æ•°æ®ï¼ˆå®žé™…é¡¹ç›®ä¸­åº”è¯¥è°ƒç”¨çœŸå®žçš„è‚¡ç¥¨APIï¼‰
        const mockData = generateMockStockData();

        // æ›´æ–°è‚¡ç¥¨æ•°æ®
        stockData.clear();
        mockData.forEach(stock => {
            stockData.set(stock.code, stock);
        });

        // ç«‹å³æ›´æ–°ä»»åŠ¡æ æ˜¾ç¤º
        updateTaskbarTitle();

        // å¯åŠ¨è‚¡ç¥¨è½®æ’­æ˜¾ç¤º
        startStockRotation();

        // é€šçŸ¥æ¸²æŸ“è¿›ç¨‹æ›´æ–°æ•°æ®
        if (mainWindow && !mainWindow.isDestroyed()) {
            mainWindow.webContents.send('stock-data-updated', Array.from(stockData.values()));
        }

        console.log('è‚¡ç¥¨æ•°æ®å·²æ›´æ–°:', new Date().toLocaleString());

    } catch (error) {
        console.error('èŽ·å–è‚¡ç¥¨æ•°æ®å¤±è´¥:', error);
    }
}

// ç”Ÿæˆæ¨¡æ‹Ÿè‚¡ç¥¨æ•°æ®
function generateMockStockData() {
    const stockNames = {
        '000001': 'å¹³å®‰é“¶è¡Œ',
        '600000': 'æµ¦å‘é“¶è¡Œ',
        '000858': 'äº”ç²®æ¶²',
        '000002': 'ä¸‡ç§‘A',
        '600036': 'æ‹›å•†é“¶è¡Œ',
        '600519': 'è´µå·žèŒ…å°'
    };

    return stockCodes.map(code => {
        const basePrice = 10 + Math.random() * 90;
        const change = (Math.random() - 0.5) * 0.1; // Â±5% å˜åŒ–
        const currentPrice = basePrice * (1 + change);
        const previousPrice = basePrice;
        const priceChange = currentPrice - previousPrice;
        const changePercent = (priceChange / previousPrice) * 100;

        return {
            code: code,
            name: stockNames[code] || `è‚¡ç¥¨${code}`,
            currentPrice: currentPrice.toFixed(2),
            previousPrice: previousPrice.toFixed(2),
            change: priceChange.toFixed(2),
            changePercent: changePercent.toFixed(2),
            volume: Math.floor(Math.random() * 1000000) + 100000,
            timestamp: new Date()
        };
    });
}

// å¯åŠ¨å®šæ—¶ä»»åŠ¡
function startScheduler() {
    if (isRunning) return;

    console.log('æ­£åœ¨å¯åŠ¨å®šæ—¶ä»»åŠ¡...');

    // ç«‹å³èŽ·å–ä¸€æ¬¡æ•°æ®
    fetchStockData();

    // è®¾ç½®å®šæ—¶ä»»åŠ¡
    schedule.scheduleJob(`*/${Math.ceil(refreshInterval / 1000)} * * * * *`, () => {
        fetchStockData();
    });

    isRunning = true;
    console.log(`è‚¡ç¥¨æ•°æ®å®šæ—¶åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš”: ${refreshInterval / 1000} ç§’`);
}

// åœæ­¢å®šæ—¶ä»»åŠ¡
function stopScheduler() {
    if (!isRunning) return;

    schedule.gracefulShutdown();
    stopStockRotation();
    isRunning = false;
    console.log('è‚¡ç¥¨æ•°æ®å®šæ—¶åˆ·æ–°å·²åœæ­¢');
}

// é‡å¯å®šæ—¶ä»»åŠ¡
function restartScheduler() {
    stopScheduler();
    startScheduler();
}

// IPCé€šä¿¡å¤„ç†
ipcMain.handle('get-stock-data', () => {
    return Array.from(stockData.values());
});

ipcMain.handle('get-settings', () => {
    return {
        refreshInterval: refreshInterval,
        stockCodes: stockCodes,
        rotationInterval: config.stockRotationInterval
    };
});

ipcMain.handle('update-settings', (event, settings) => {
    refreshInterval = settings.refreshInterval;
    stockCodes = settings.stockCodes;

    // æ›´æ–°é…ç½®
    if (settings.rotationInterval) {
        config.stockRotationInterval = settings.rotationInterval;
    }

    // é‡å¯å®šæ—¶ä»»åŠ¡
    restartScheduler();

    return { success: true };
});

ipcMain.handle('fetch-stock-data', () => {
    fetchStockData();
    return { success: true };
});

// æ˜¾ç¤ºå³é”®èœå•
function showContextMenu(x, y) {
    const contextMenu = Menu.buildFromTemplate([
        {
            label: 'è‚¡ç¥¨è¡Œæƒ…',
            enabled: false
        },
        { type: 'separator' },
        ...Array.from(stockData.values()).map(stock => ({
            label: `${stock.code} ${stock.name}: Â¥${stock.currentPrice} ${stock.change >= 0 ? '+' : ''}${stock.change} (${stock.changePercent}%)`,
            enabled: false
        })),
        { type: 'separator' },
        {
            label: 'æ˜¾ç¤ºçª—å£',
            click: () => {
                mainWindow.show();
                mainWindow.focus();
            }
        },
        {
            label: 'è®¾ç½®',
            click: () => {
                mainWindow.show();
                mainWindow.focus();
                mainWindow.webContents.send('open-settings');
            }
        },
        {
            label: 'ç«‹å³åˆ·æ–°',
            click: () => {
                fetchStockData();
            }
        },
        { type: 'separator' },
        {
            label: 'é€€å‡º',
            click: () => {
                app.isQuiting = true;
                app.quit();
            }
        }
    ]);

    contextMenu.popup({ x, y });
}

// åº”ç”¨äº‹ä»¶å¤„ç†
app.whenReady().then(() => {
    console.log('åº”ç”¨å·²å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹åˆå§‹åŒ–...');

    createWindow();
    createTaskbarButton();
    startScheduler();

    // åœ¨macOSä¸Šï¼Œå½“æ‰€æœ‰çª—å£éƒ½å…³é—­æ—¶ï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªçª—å£
    app.on('activate', () => {
        if (BrowserWindow.getAllWindows().length === 0) {
            createWindow();
        }
    });

    console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
});

// å½“æ‰€æœ‰çª—å£éƒ½å…³é—­æ—¶é€€å‡ºåº”ç”¨
app.on('window-all-closed', () => {
    if (process.platform !== 'darwin') {
        app.quit();
    }
});

// åº”ç”¨é€€å‡ºå‰æ¸…ç†
app.on('before-quit', () => {
    stopScheduler();
});

// å¤„ç†åº”ç”¨é€€å‡º
app.on('quit', () => {
    stopScheduler();
});
