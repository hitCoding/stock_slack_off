# 打包后配置文件位置说明

## 问题描述
在使用 `npm run build` 编译成 exe 文件后，应用无法保存增加的股票代码和读取配置。

## 原因分析
在 Electron 应用打包后：
1. `__dirname` 指向临时目录，而不是应用安装目录
2. 资源文件路径发生变化
3. 应用没有权限在临时目录写入文件

## 解决方案
已修改代码，配置文件始终保存在执行目录：

### 配置文件存储位置
- **开发环境**: 应用根目录下的 `stock-codes.json`
- **生产环境**: exe 文件所在目录下的 `stock-codes.json`

### 具体路径
#### Windows
```
C:\Users\{用户名}\Desktop\股票行情小工具.exe 所在目录\stock-codes.json
```

#### macOS
```
~/Desktop/股票行情小工具.app 所在目录/stock-codes.json
```

#### Linux
```
~/Desktop/股票行情小工具 所在目录/stock-codes.json
```

## 修改内容

### 1. 配置文件路径
```javascript
// 获取配置文件目录
function getUserDataPath() {
    // 始终使用执行目录，无论是开发环境还是生产环境
    return __dirname;
}

// 配置文件路径
const STOCK_CODES_FILE = path.join(getUserDataPath(), 'stock-codes.json');
```

### 2. 资源文件路径
```javascript
// 获取资源文件路径
function getResourcePath(relativePath) {
    // 始终使用执行目录，无论是开发环境还是生产环境
    return path.join(__dirname, relativePath);
}
```

### 3. 自动创建目录
```javascript
// 确保配置目录存在
const configDir = path.dirname(STOCK_CODES_FILE);
if (!fs.existsSync(configDir)) {
    fs.mkdirSync(configDir, { recursive: true });
}
```

## 验证方法

### 1. 查看控制台日志
启动应用后，控制台会显示：
```
🔍 尝试加载配置文件: C:\Users\{用户名}\Desktop\股票行情小工具.exe 所在目录\stock-codes.json
📁 配置文件目录: C:\Users\{用户名}\Desktop\股票行情小工具.exe 所在目录
📁 当前目录: C:\Users\{用户名}\Desktop\股票行情小工具.exe 所在目录
📁 资源路径: 未定义
```

### 2. 检查文件位置
1. 在应用中添加股票代码
2. 检查用户数据目录是否生成了 `stock-codes.json` 文件
3. 重启应用，确认配置是否被正确加载

### 3. 手动创建配置文件
如果自动创建失败，可以手动创建：
1. 找到用户数据目录
2. 创建 `stock-codes.json` 文件
3. 添加基本配置：
```json
{
  "stockCodes": ["000001", "600000"],
  "lastUpdated": "2025-01-01T00:00:00.000Z",
  "timers": {
    "stockDisplayInterval": 3000,
    "dataRefreshInterval": 30000
  }
}
```

## 常见问题

### Q: 配置文件仍然无法保存
**A**: 检查用户数据目录的写入权限，确保应用有权限在该目录创建文件。

### Q: 资源文件（图标、HTML）无法加载
**A**: 确保在打包配置中包含了所有必要的资源文件。

### Q: 开发环境和生产环境路径不一致
**A**: 这是正常现象，代码会自动判断环境并使用相应的路径。

## 注意事项

1. **权限问题**: 确保应用有权限访问用户数据目录
2. **路径分隔符**: 在不同操作系统上，路径分隔符可能不同
3. **编码问题**: 配置文件使用 UTF-8 编码
4. **备份**: 建议定期备份配置文件

## 常见错误及解决方案

### 缓存相关错误
如果遇到以下错误：
```
ERROR:cache_util_win.cc(20)] Unable to move the cache: 拒绝访问 (0x5)
ERROR:disk_cache.cc(208)] Unable to create cache
ERROR:gpu_disk_cache.cc(676)] Gpu Cache Creation failed
```

**解决方案**:
1. **使用无缓存启动脚本**:
   - 双击 `start-no-cache.bat` 或 `start-no-cache.ps1`
   - 这些脚本会设置环境变量来禁用问题缓存

2. **以管理员身份运行**:
   - 右键点击 exe 文件
   - 选择"以管理员身份运行"

3. **检查防病毒软件**:
   - 将应用目录添加到防病毒软件白名单
   - 临时禁用实时保护

4. **清理系统缓存**:
   - 运行 `%temp%` 清理临时文件
   - 清理浏览器缓存

### 启动参数说明
应用支持以下启动参数来减少错误：
- `--disable-gpu-cache`: 禁用 GPU 缓存
- `--disable-software-rasterizer`: 禁用软件光栅化
- `--disable-gpu-sandbox`: 禁用 GPU 沙盒
- `--no-sandbox`: 禁用沙盒模式
- `--disable-dev-shm-usage`: 禁用共享内存

## 技术细节

### Electron 路径 API
- `app.getPath('userData')`: 用户数据目录
- `app.getPath('appData')`: 应用数据目录
- `app.getPath('temp')`: 临时目录
- `process.resourcesPath`: 资源文件目录（打包后）

### 环境检测
- `process.env.NODE_ENV`: 环境变量
- `process.argv.includes('--dev')`: 开发模式标志
- `process.resourcesPath`: 资源路径（仅生产环境）

### 文件操作
- `fs.existsSync()`: 检查文件是否存在
- `fs.mkdirSync()`: 创建目录
- `fs.writeFileSync()`: 写入文件
- `fs.readFileSync()`: 读取文件
